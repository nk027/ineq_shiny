---
pagetitle: "Ineq"
author: "Nikolas Kuschnig"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    css: style.css
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries
library(dplyr)
library(plotly)
library(ggplot2)
# library(countrycode) # use this to reformat names someday

teals <- c("#c6e2e2", "#a4d1d1", "#7bbdbd", "#49a4a4", "#008080", "#007373")

# Data
neighbours <- data.frame("AT" = c("DE", "IT", "SI", "HU", "CZ")) # KNN?
data_widget <- readRDS("data/widget.rds")
map_poverty <- readRDS("data/poverty_map.rds")
data <- readRDS("data/eurostat.rds") # Break down
```

```{r, echo=FALSE}
#
# HTML elements
#

# Input for country selection
selector <- selectInput("country", NULL, choices = data_widget$mean_inc$country)
tags$div(
  class = "main_selection",
  tags$h1("Inequality Profile for"),
  selector
)

# Header overview-widget
html_overview <- function(title, number, units, 
                          color,
                          href_id) {
  color_hover <- paste0(color, "-h")
  
  out <- tags$div(class = "col-sm-3 plr-5",
  tags$a(href = paste0("#", href_id), 
    class = paste("card widget-card h-100", color_hover),
    tags$div(class = "card-block font-weight-300 py-2 px-2",
    tags$div(class = "media",
    tags$div(class = "d-flex mr-2 align-self-center"),
    tags$div(class = paste("pos-abs width-2 height-2 crnr", color))),
    tags$div(class = "media-body align-self-center",
    tags$div(class = "align-items-center",
    tags$div(class = "widget-title", title),
    tags$div(class = "widget-number-element",
    tags$span(class = "widget-number", number)), 
    tags$div(class = "widget-unit", units)
    ))))
  )
  return(out)
}

# Prepare Values to be displayed
  # We still need:
  # req(input) somewhere, &
  # isolate() others
  # to minimise operations
output$mean_inc <- renderText(
  format(data_widget$mean_inc$values[data_widget$mean_inc$country == input$country], 
         digits = 5, big.mark = ",")
)
output$med_inc <- renderText(
  format(data_widget$med_inc$values[data_widget$med_inc$country == input$country], 
         digits = 5, big.mark = ",")
)
output$gini <- renderText(
  format(data_widget$gini$values[data_widget$gini$country == input$country], 
         digits = 2, big.mark = ",")
)
output$qsr80 <- renderText(
  format(data_widget$qsr$values[data_widget$qsr$country == input$country], 
         digits = 3, big.mark = ",")
)
output$pov <- renderText(
  format(data_widget$pov$values[data_widget$pov$country == input$country], 
         digits = 3, big.mark = ",")
)
output$pov_th <- renderText(
  format(data_widget$pov_th$values[data_widget$pov_th$country == input$country], 
         digits = 3, big.mark = ",")
)
output$top10 <- renderText(
  format(data_widget$top10$values[data_widget$top10$country == input$country], 
         digits = 3, big.mark = ",")
)

# Create reactive text elements
tags$div(
  class = "row row-tight my-2 mb-2",
  html_overview(
    title = "Mean Income",
    number = textOutput("mean_inc", inline = FALSE),
    units = "(in EUR)",
    color = "bg-yellow",
    href_id = "section1"),
  html_overview(
    title = "Median Income",
    number = textOutput("med_inc", inline = FALSE),
    units = "(in EUR)",
    color = "bg-purple",
    href_id = "section1"),
  html_overview(
    title = "Gini Index",
    number = textOutput("gini", inline = FALSE),
    units = "(0 to 1)",
    color = "bg-darkblue",
    href_id = "section1"),
  html_overview(
    title = "Quantile Share Ratio",
    number = textOutput("qsr80", inline = FALSE),
    units = "(80 to 20)",
    color = "bg-yellow",
    href_id = "section1")
)
tags$div(
  class = "row row-tight my-2 mb-2",
  html_overview(
    title = "Poverty-risk Rate",
    number = textOutput("pov", inline = FALSE),
    units = "(in percent)",
    color = "bg-purple",
    href_id = "section1"),
  html_overview(
    title = "Poverty-risk Threshold",
    number = textOutput("pov_th", inline = FALSE),
    units = "(in EUR)",
    color = "bg-darkblue",
    href_id = "section1"),
  html_overview(
    title = "Top 10% Income Share",
    number = textOutput("top10", inline = FALSE),
    units = "(in percent)",
    color = "bg-yellow",
    href_id = "section1")
)
```

```{r echo=FALSE}
#
# Functions and stuff
#

output$info1 <- renderText({
  req(input$country)
  
  text_data <- data_widget$pov %>% 
    filter(country == input$country) %>% 
    select(values)
  improved <- text_data < 15
  # To-do: Think of some text to generate
  sprintf("%s has a %s at-risk-of-poverty rate!", isolate({input$country}),
          ifelse(improved, "low (<15%)", "high (>15%)"))
})

plot_inc <- renderPlotly({
  req(input$country)
  
  inc_mean_self <- data$inc_mean %>% 
    filter(geo == input$country, time >= "2005-01-01")
  inc_med_self <- data$inc_med %>% 
    filter(geo == input$country, time >= "2005-01-01")
  
  inc_mean <- data$inc_mean %>% 
    filter(geo %in% neighbours[[input$country]], time >= "2005-01-01")
  inc_med <- data$inc_med %>% 
    filter(geo %in% neighbours[[input$country]], time >= "2005-01-01")
  
  ggplot_inc <- ggplot(inc_mean_self, aes(x = time, colour = geo)) +
    scale_color_manual(values = rev(teals)) +
    geom_ribbon(data = inc_mean,
                aes(ymin = inc_mean$values, ymax = inc_med$values), 
                fill = rgb(0.2, 0.2, 0.2, 0.1)) +
    geom_ribbon(aes(ymin = inc_mean_self$values, ymax = inc_med_self$values),
                colour = "#aa2020", fill = rgb(0, 0, 0, 0)) +
    geom_ribbon(aes(ymin = inc_mean_self$values, ymax = inc_med_self$values), 
                fill = "#aa2020", alpha = 0.2) +
    scale_x_date(expand = c(0, 0), labels = scales::date_format("%Y")) +
    scale_y_continuous(labels = scales::number_format(), expand = c(0, 0)) +
    theme(
      axis.title = element_blank(),
      legend.position = "right",
      legend.justification = "center",
      legend.background = element_blank(),
      legend.title = element_blank(),
      panel.background = element_blank(),
      panel.grid.major.x = element_blank(),
      panel.grid.major.y = element_line(colour = rgb(0.85, 0.85, 0.85), size = 0.2),
      panel.grid.minor = element_blank(),
      plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "lines"))

  ggplotly(ggplot_inc, tooltip = "geo") %>% 
    plotly::config(displaylogo = FALSE, collaborate = FALSE) %>% 
    layout(legend = list(orientation = "v", yanchor = "center", y = 0.6))
})

plot_map <- renderPlotly({
  map_poverty %>% 
    plot_ly(split = ~geo, color = ~values, 
            text = ~paste(geo, "\n", values),
            hoverinfo = "text", hoveron = "fill",
            alpha = 1, showlegend = FALSE) %>% 
    layout(xaxis = list(autorange = FALSE, range = c(-10, 30)), 
           yaxis = list(autorange = FALSE, range = c(32, 70))) %>% 
    colorbar(title = "in percent", ticksuffix = "%") %>% 
    plotly::config(displaylogo = FALSE, collaborate = FALSE)
})
```


```{r, echo=FALSE}
#
# Section 1
#

# Header for section #1
# tags$div(class = "mb-4", id = "section1",
#   tags$h1(class = "color-yellow mb-2",
#           HTML("Section #1")),
#   tags$div(class = "row mt-4 mb-4",
#   tags$div(class = "col-sm-12",
#            HTML("Some information about indicators in section #1.")))
# )

# First row of section 1, one full-width card
tags$div(class = "card mb-2", id = "section1",
  tags$div(class = "card-header",
           HTML("Mean and median incomes over time")),
  tags$div(class = "card-body",
           HTML("The distance between mean and median income indicates skewedness of the income distribution.")),
  tags$div(class = "card-body",
  plot_inc)
)

# Second row of section 1, three cards beside each other
tags$div(class = "row", id = "section2",
  tags$div(class = "col-sm-6",
  tags$div(class = "card", 
  tags$div(class = "card-header",
           HTML("Display reactive text")),
  tags$div(class = "card-body",
           htmlOutput("info1")))),
  tags$div(class = "col-sm-6",
  tags$div(class = "card", 
  tags$div(class = "card-header",
           HTML("At-risk-of-poverty rates across Europe")),
  tags$div(class = "card-body",
           style = "height: 400;",
           plot_map)))
)
```
